name: Check docker-compose

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install PostgreSQL
        run: |
          sudo apt update
          sudo apt install -y postgresql postgresql-contrib

      - name: Start PostgreSQL service
        run: |
          sudo service postgresql start

      - name: Set up PostgreSQL database and user
        run: |
          # Устанавливаем пароль для пользователя postgres
          sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"
          
          # Создаем базу данных и пользователя
          sudo -u postgres psql -c "CREATE DATABASE homecloud;"
          sudo -u postgres psql -d homecloud -c "CREATE USER homecloudauthsevice WITH ENCRYPTED PASSWORD '123';"
          sudo -u postgres psql -d homecloud -c "GRANT ALL PRIVILEGES ON DATABASE homecloud TO homecloudauthsevice;"

      - name: Install Docker
        run: |
          sudo apt install -y docker.io docker-compose

      - name: Start Docker Compose
        run: |
          cd server
          # Создаем директорию для логов
          mkdir -p log
          # Запускаем docker-compose и записываем логи в файл
          docker-compose -f docker-compose.yml up -d --build > log/docker.log 2>&1

      - name: Upload log artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-log
          path: server/log/docker.log